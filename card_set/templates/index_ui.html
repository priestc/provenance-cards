<html>
{% load static %}
  <body>
    <script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous"></script>

    <script src="{% static 'html2canvas.min.js' %}"></script>

    <script>
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/player_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      var shorthands = {{ shorthands_json|safe }};
      var expected_pulls = {{ expected_pulls }};
    </script>

    <h1>Card Provanance</h1>
    <h2>Index New {{ product }}</h2>

    <div id="step1">
      Youtube video id: <input type="text" id="youtube_id"><br>
      <input type="button" id="next1" value="Next">
    </div>

    <div id="ytplayer"></div>

    <table id="pulls">
      <tr>
        <td>Timestamp</td><td>Subset</td><td>Serial</td><td>Player</td><td>Damage</td>
      </tr>
      <tr id="pull_template" style="display: none">
        <td>
          <input class="snap" type="button" value="Snap">
          <input class="timestamp" type="text">
        </td>
        <td>
          <select class="subset">
            <option value="---">----</option>
            {% for name in dropdowns.name %}
              <option value="{{ name.0 }}">{{ name.0 }}</option>
            {% endfor %}
          </select>
          <br>
          <select class="color">
            <option value="---">----</option>
            {% for color in dropdowns.color %}
              <option value="{{ color.0 }}">{{ color.0 }}</option>
            {% endfor %}
          </select>
          <br><input class="shorthand" type="text">
        </td>
        <td>
          <input class="serial" type="text">
        </td>
        <td>
          <select class="player">
            <option value="---">----</option>
            {% for player in players %}
              <option value="{{ player }}">{{ player }}</option>
            {% endfor %}
          </select>
        </td>
        <td>
          <input class="damage" type="text">
        </td>
      </tr>
    </table>


    <button id="new_card">New Card</button>

    <script>
      $("body").on("keyup", ".shorthand", function(){
        var tthis = $(this)
        var shorthand = tthis.val();
        var selection = shorthands[shorthand];
        if(selection) {
          var color = selection[1];
          var subset = selection[0]
          tthis.parent().find(".color").val(color);
          tthis.parent().find(".subset").val(subset);
        }
      });

      $("body").on("click", ".snap", function(){
        var index = $(this).parent().parent()[0].data("index");
        console.log($(this).parent().parent());
      });

      $("#new_card").click(function(){
        var next_index = $(".pull").length + 1;
        var t = $("#pull_template").clone().removeAttr('id').addClass("pull");
        t.appendTo($("#pulls"))
        t.show().attr("index", next_index)
      });

      $("#next1").click(function(){
        var vid_id = $("#youtube_id").val();
        $.ajax({
          "url": "/register_video/",
          "data": {'youtube_id': vid_id},
          "type": "post"
        }).done(function(response){
          console.log(response);
          if(response['error']) {
            alert(response['error']);
          } else {
            embed_video(vid_id);
          }
        });
      });

      for(var x = 0; x < expected_pulls; x++) {
        $('#new_card').click();
      }

      var player;
      function embed_video(vid_id) {
        player = new YT.Player('ytplayer', {
          height: '360',
          width: '640',
          videoId: vid_id
        });
      }

      function get_timestamp(pull_index) {
        var shot_id = $("");

        html2canvas(document.getElementById('ytplayer')).then(function(canvas) {
            document.getElementById(shot_id).appendChild(canvas);
        });
        return player.playerInfo.currentTime;
      }
    </script>
  </body>

</html>
